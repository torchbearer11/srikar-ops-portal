<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Srikar Jewellers Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {--gold-primary: #DCCA87;--dark-bg: #0C0C0C;--text-primary: #FFFFFF;--text-secondary: #AAAAAA;}
        body {font-family: 'Poppins', sans-serif;background-color: var(--dark-bg);color: var(--text-secondary);margin:0;}
        .hidden { display: none !important; }
        .container {max-width: 1800px;margin: 1rem auto;background: #181818;border-radius: 20px;}
        .header {padding: 2rem;display: flex;justify-content: space-between;align-items: center;border-bottom: 1px solid #333;}
        .header-text h1 {font-family: 'Cormorant Garamond', serif;color: var(--gold-primary);}
        .header-user-info { display: flex; align-items: center; gap: 1rem; }
        .nav-tabs {display: flex;overflow-x: auto;border-bottom: 1px solid #333;}
        .nav-tabs button {background: transparent;border: none;padding: 1.2rem 1.5rem;font-size: 1rem;cursor: pointer;color: var(--text-secondary);white-space: nowrap;}
        .nav-tabs button.active {color: var(--gold-primary);border-bottom: 2px solid var(--gold-primary);}
        .tab-content {padding: 2rem; display: none;}
        .tab-content.active {display: block;}
        .btn {padding: 0.6rem 1.2rem;border: 1px solid var(--gold-primary);border-radius: 8px;cursor: pointer;background: transparent;color: var(--gold-primary);}
    </style>
</head>
<body>
    <div class="container hidden">
        <header class="header">
            <div class="header-text"><h1>Operations Portal</h1><p id="portal-subtitle"></p></div>
            <div class="header-user-info"><span id="user-email-display"></span><button id="logoutButton" class="btn">Logout</button></div>
        </header>
        <div class="nav-tabs" id="nav-tabs-container"></div>
        <div id="tab-content-wrapper"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBJkFO2l12n4hKLbNd1vEMgz87GFzH77lg",
            authDomain: "srikar-jewellers-crm.firebaseapp.com",
            projectId: "srikar-jewellers-crm",
            storageBucket: "srikar-jewellers-crm.appspot.com",
            messagingSenderId: "377625912262",
            appId: "1:377625912262:web:d6d05bec0d817e211b48c7",
            measurementId: "G-06K93QM4V4"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const mainContainer = document.querySelector('.container');
        const userEmailDisplay = document.getElementById('user-email-display');
        const logoutButton = document.getElementById('logoutButton');
        const portalSubtitle = document.getElementById('portal-subtitle');
        const navTabsContainer = document.getElementById('nav-tabs-container');
        const tabContentWrapper = document.getElementById('tab-content-wrapper');
        let currentUser = null;
        let idToken = null;

        auth.onAuthStateChanged(async user => {
            if (user) {
                currentUser = user;
                userEmailDisplay.textContent = user.email;
                idToken = await user.getIdToken(true);
                const response = await fetch('/.netlify/functions/get-user-data', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
                if (response.ok) {
                    const { role } = await response.json();
                    mainContainer.classList.remove('hidden');
                    initializeApp(role);
                } else {
                    alert('Could not verify your role. Logging out.');
                    auth.signOut();
                }
            } else {
                if (!window.location.pathname.endsWith('login.html')) {
                    window.location.href = '/login.html';
                }
            }
        });

        logoutButton.addEventListener('click', () => auth.signOut());

        function initializeApp(role) {
            setupUIForRole(role);
        }

        function setupUIForRole(role) {
            navTabsContainer.innerHTML = '';
            tabContentWrapper.innerHTML = '';
            portalSubtitle.textContent = `${role} Dashboard`;
            const staffTabs = [{ id: 'my-tasks', name: 'My Tasks' },{ id: 'attendance', name: 'Attendance' }];
            const adminTabs = [{ id: 'dashboard', name: 'Dashboard' },{ id: 'task-management', name: 'Task Management' },{ id: 'staff-management', name: 'Staff Management' },{ id: 'crm-view', name: 'CRM Data' }];
            const tabsToRender = (role === 'Admin') ? adminTabs : staffTabs;
            tabsToRender.forEach((tab, index) => {
                const isActive = index === 0;
                navTabsContainer.innerHTML += `<button class="tab-button ${isActive ? 'active' : ''}" onclick="showTab('${tab.id}', this)">${tab.name}</button>`;
                tabContentWrapper.innerHTML += `<div id="${tab.id}" class="tab-content ${isActive ? 'active' : ''}"><h2>${tab.name}</h2><p>Content for this section will be built in the next phase.</p></div>`;
            });
        }

        function showTab(tabName, element) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (element) element.classList.add('active');
        }
    </script>
</body>
</html>
